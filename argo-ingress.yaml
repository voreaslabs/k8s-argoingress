# ===============================================================
# 1. ROUTE 53 PRIVATE HOSTED ZONE
# ===============================================================
apiVersion: route53.aws.upbound.io/v1beta1
kind: Zone
metadata:
  name: vli-dev-zone
  labels:
    vli.io/environment: dev
spec:
  forProvider:
    name: vli.dev.com
---
# ===============================================================
# 2. ACM CERTIFICATE (For HTTPS over VPN)
# ===============================================================
apiVersion: acm.aws.upbound.io/v1beta1
kind: Certificate
metadata:
  name: argocd-cert
  labels:
    vli.io/environment: dev
    vli.io/component: argocd-ssl
spec:
  forProvider:
    domainName: argo.vli.dev.com
    validationMethod: DNS
    region: us-east-1
---
# ===============================================================
# 3. DNS VALIDATION RECORD (Automates Certificate Issuance)
# ===============================================================
apiVersion: route53.aws.upbound.io/v1beta1
kind: Record
metadata:
  name: argocd-cert-validation-record
spec:
  forProvider:
    type: CNAME
    ttl: 60
    zoneIdSelector:
      matchLabels:
        vli.io/environment: dev
    nameSelector:
      matchLabels:
        vli.io/component: argocd-ssl
    recordsSelector:
      matchLabels:
        vli.io/component: argocd-ssl
---
# ===============================================================
# 4. SECURITY GROUP (Allows Internal ALB to reach Fargate Pods)
# ===============================================================
apiVersion: ec2.aws.upbound.io/v1beta1
kind: SecurityGroup
metadata:
  name: argocd-server-sg-managed
spec:
  forProvider:
    region: us-east-1
    vpcIdSelector:
      matchLabels:
        networking.vli.io/environment: dev
    description: Allow Internal ALB to ArgoCD Pods
    groupName: argocd-server-fargate-sg
    tags:
      Name: argocd-server-sg
---
# ===============================================================
# 5. INTERNAL INGRESS (ArgoCD URL via VPN)
# ===============================================================
apiVersion: kubernetes.crossplane.io/v1alpha1
kind: Object
metadata:
  name: argocd-ingress-controller
spec:
  forProvider:
    manifest:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: argocd-server-ingress
        namespace: argocd
        annotations:
          # Sets ALB to Internal (Private Subnets)
          alb.ingress.kubernetes.io/scheme: internal
          alb.ingress.kubernetes.io/target-type: ip
          alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
          alb.ingress.kubernetes.io/actions.ssl-redirect: |
            {"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}
          alb.ingress.kubernetes.io/healthcheck-path: /healthz
          alb.ingress.kubernetes.io/backend-protocol: HTTP
          # Placeholder: Injected by the reference below
          alb.ingress.kubernetes.io/certificate-arn: "" 
      spec:
        ingressClassName: alb
        rules:
          - host: argo.vli.dev.com 
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: ssl-redirect
                      port:
                        name: use-annotation
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: argocd-server
                      port:
                        number: 80
  
  # This section dynamically links the Certificate to the Ingress
  references:
    - fromFieldPath: "status.atProvider.arn"
      toFieldPath: "spec.forProvider.manifest.metadata.annotations['alb.ingress.kubernetes.io/certificate-arn']"
      resource:
        apiVersion: acm.aws.upbound.io/v1beta1
        kind: Certificate
        labelSelector:
          matchLabels:
            vli.io/environment: dev